# Chapter 9. 옵티마이저와 힌트

## 쿼리 실행 절차
1. 사용자로부터 요청된 SQL 문장을 쪼개서 MySQL 서버가 이해할 수 있는 수준으로 분리(파스 트리)한다.
2. SQL의 파싱 정보(파스 트리)를 확인하면서 어떤 테이블부터 읽고 어떤 인덱스를 이용해 테이블을 읽을지 선택한다.
3. 두 번째 단계에서 결정된 테이블의 읽기 순서나 선택된 인덱스를 이용해 스토리지 엔진으로부터 데이터를 가져온다.

* 첫 번째 단계를 "SQL 파싱"이라고 하며, MySQL 서버의 "SQL 파서"라는 모듈로 처리한다.
  * SQL 문장이 문법적으로 잘못 됐다면 이 단계에서 걸러진다.
  * 이 단계에서 "SQL 파스 트리"가 만들어진다.
  * MySQL 서버는 SQL 문장이 아닌, SQL 파스 트리를 이용하여 쿼리를 실행한다.
* 두 번째 단계에서는 첫 번째 단계에서 만들어진 SQL 파스 트리를 참조하면서 다음과 같은 내용을 처리한다.
  * 불필요한 조건 제거 및 복잡한 연산 단순화
  * 여러 테이블의 조인이 있는 경우 어떤 순서로 테이블을 읽을지 결정
  * 각 테이블에 사용된 조건과 인덱스 통계 정보를 이용해 사용할 인덱스를 결정
  * 가져온 레코드들을 임시 테이블에 넣고 다시 한번 가공해야 하는지 결정
* 두 번째 단계는 "최적화 및 실행 계획 수립" 단계이며, MySQL 서버의 옵티마이저에서 처리한다.
  * 이 단계가 완료되면 실행 계획이 만들어진다.
* 세 번째 단계는 수립된 실행 계획대로 스토리지 엔진에 레코드를 읽어오도록 요청하고, MySQL 엔진에서는 스토리지 엔진으로부터 받은 레코드를 조인하거나 정렬하는 작업을 수행한다.
* 첫 번째 단계와 두 번째 단계는 거의 MySQL 엔진에서 처리하며, 세 번째 단계는 MySQL 엔진과 스토리지 엔진이 동시에 참여해서 처리한다.

### 옵티마이저의 종류
* 비용 기반 최적화(Cost-based optimizer, CBO)
  * 현재 대부분의 RDMS가 선택하고 있는 옵티마이저 최적화 방법이다.
  * 쿼리를 처리하기 위한 여러 가지 가능한 방법을 만들고, 각 단위 작업의 비용 정보와 대상 테이블의 예측된 통계 정보를 이용해 실행 계획별 비용을 산출한다.
  * 산출된 실행 방법별로 비용이 최소로 소요되는 처리 방식을 선택해 최종적으로 쿼리를 실행한다.
* 규칙 기반 최적화(Rule-based optimizer, RBO)
  * 대상 테이블의 레코드 건수나 선택도 등을 고려하지 않고 옵티마이저에 내장된 우선순위에 따라 실행 계획을 수립하는 방식이다.
  * 통계 정보를 조사하지 않고 실행 계획이 수립되기 때문에 같은 쿼리에 대해서는 거의 항상 같은 실행 방법을 만들어 낸다.
  * 오래전부터 많은 RDBMS에서 거의 사용하지 않는다.

## 풀 테이블 스캔과 풀 인덱스 스캔

### 풀 테이블 스캔
* 인덱스를 사용하지 않고 테이블의 데이터를 처음부터 끝까지 읽어서 요청된 작업을 처리한다.
  * 테이블의 레코드 건수가 너무 적어서 인덱스를 통해 읽는 것보다 풀 테이블 스캔이 더 빠른 경우에 풀 테이블 스캔을 사용한다.
  * WHERE 절이나 ON 절에 인덱스를 이용할 수 있는 적절한 조건이 없는 경우에 풀 테이블 스캔을 사용한다.
  * 인덱스 레인지 스캔을 사용할 수 있는 쿼리라고 하더라도 옵티마이저가 판단한 조건 일치 레코드 건수가 너무 많은 경우(인덱스의 B-Tree를 샘플링해서 조사한 통계 정보 기준)에 풀 테이블 스캔을 사용한다.
* 일반적으로 테이블의 전체 크기는 인덱스보다 훨씬 크기 때문에 테이블을 처음부터 끝까지 읽는 작업은 대량의 디스크 읽기 작업을 필요로 한다.
* InnoDB 스토리지 엔진은 특정 테이블의 연속된 데이터 페이지가 읽히면 백그라운드 스레드에 의해 리드 어헤드(Read ahead) 작업이 자동으로 시작된다.
* 리드 어헤드란 어떤 영역의 데이터가 앞으로 필요해지리라는 것을 예측하여 요청이 오기 전에 미리 디스크에서 읽어 InnoDB의 버퍼 풀에 캐싱해 두는 것을 의미한다.
  * 즉, 풀 테이블 스캔이 실행되면 처음 몇 개의 데이터 페이지는 포그라운드 스레드가 페이지 읽기를 실행하지만 특정 시점부터는 읽기 작업을 백그라운드 스레드로 넘긴다.
* 리드 어헤드는 풀 인덱스 스캔에서도 동일하게 사용된다.
